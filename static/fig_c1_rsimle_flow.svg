<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.43.0 (0)
 -->
<!-- Title: c1_rsimle_flow Pages: 1 -->
<svg width="2400pt" height="177pt"
 viewBox="0.00 0.00 2400.00 177.18" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 173.18)">
<title>c1_rsimle_flow</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-173.18 2396,-173.18 2396,4 -4,4"/>
<!-- batch -->
<g id="node1" class="node">
<title>batch</title>
<polygon fill="#ffffff" stroke="black" points="163,-113.68 0,-113.68 0,-75.68 163,-75.68 163,-113.68"/>
<text text-anchor="middle" x="81.5" y="-98.48" font-family="Times,serif" font-size="14.00">Mini&#45;batch</text>
<text text-anchor="middle" x="81.5" y="-83.48" font-family="Times,serif" font-size="14.00">{(O_i,A_i)}_{i=1..B}</text>
</g>
<!-- encC -->
<g id="node2" class="node">
<title>encC</title>
<polygon fill="#ffcdd2" stroke="black" points="333,-113.68 221,-113.68 221,-75.68 333,-75.68 333,-113.68"/>
<text text-anchor="middle" x="277" y="-98.48" font-family="Times,serif" font-size="14.00">Encode → C_i</text>
<text text-anchor="middle" x="277" y="-83.48" font-family="Times,serif" font-size="14.00">(B,T_o,d)</text>
</g>
<!-- batch&#45;&gt;encC -->
<g id="edge1" class="edge">
<title>batch&#45;&gt;encC</title>
<path fill="none" stroke="black" d="M163.16,-94.68C178.92,-94.68 195.26,-94.68 210.45,-94.68"/>
<polygon fill="black" stroke="black" points="210.76,-98.18 220.76,-94.68 210.76,-91.18 210.76,-98.18"/>
</g>
<!-- genK -->
<g id="node3" class="node">
<title>genK</title>
<path fill="#e1d5e7" stroke="black" d="M616,-121.18C616,-121.18 403,-121.18 403,-121.18 397,-121.18 391,-115.18 391,-109.18 391,-109.18 391,-80.18 391,-80.18 391,-74.18 397,-68.18 403,-68.18 403,-68.18 616,-68.18 616,-68.18 622,-68.18 628,-74.18 628,-80.18 628,-80.18 628,-109.18 628,-109.18 628,-115.18 622,-121.18 616,-121.18"/>
<text text-anchor="middle" x="509.5" y="-105.98" font-family="Times,serif" font-size="14.00">Batched generation</text>
<text text-anchor="middle" x="509.5" y="-90.98" font-family="Times,serif" font-size="14.00">K latents per item → {Â_i^(k)}</text>
<text text-anchor="middle" x="509.5" y="-75.98" font-family="Times,serif" font-size="14.00">(B,K,T_p,7)</text>
</g>
<!-- encC&#45;&gt;genK -->
<g id="edge2" class="edge">
<title>encC&#45;&gt;genK</title>
<path fill="none" stroke="black" d="M333.21,-94.68C347.66,-94.68 363.85,-94.68 380.41,-94.68"/>
<polygon fill="black" stroke="black" points="380.75,-98.18 390.75,-94.68 380.75,-91.18 380.75,-98.18"/>
</g>
<!-- dist_item -->
<g id="node4" class="node">
<title>dist_item</title>
<polygon fill="#fff2cc" stroke="black" points="1152,-169.18 956,-169.18 956,-116.18 1152,-116.18 1152,-169.18"/>
<text text-anchor="middle" x="1054" y="-153.98" font-family="Times,serif" font-size="14.00">Per&#45;item distances</text>
<text text-anchor="middle" x="1054" y="-138.98" font-family="Times,serif" font-size="14.00">D_{i,k}=D_ρ(Â_i^(k),A_i)</text>
<text text-anchor="middle" x="1054" y="-123.98" font-family="Times,serif" font-size="14.00">(norm by T_p)</text>
</g>
<!-- genK&#45;&gt;dist_item -->
<g id="edge3" class="edge">
<title>genK&#45;&gt;dist_item</title>
<path fill="none" stroke="black" d="M628.21,-105.09C722.68,-113.45 854.19,-125.09 945.77,-133.19"/>
<polygon fill="black" stroke="black" points="945.62,-136.69 955.89,-134.09 946.24,-129.72 945.62,-136.69"/>
</g>
<!-- dist_bg -->
<g id="node5" class="node">
<title>dist_bg</title>
<polygon fill="#fff2cc" stroke="black" points="898,-80.18 686,-80.18 686,-27.18 898,-27.18 898,-80.18"/>
<text text-anchor="middle" x="792" y="-64.98" font-family="Times,serif" font-size="14.00">Batch&#45;global distances</text>
<text text-anchor="middle" x="792" y="-49.98" font-family="Times,serif" font-size="14.00">D_{i,k→j}=D_ρ(Â_i^(k),A_j)</text>
<text text-anchor="middle" x="792" y="-34.98" font-family="Times,serif" font-size="14.00">vectorized (BK,B)</text>
</g>
<!-- genK&#45;&gt;dist_bg -->
<g id="edge4" class="edge">
<title>genK&#45;&gt;dist_bg</title>
<path fill="none" stroke="black" d="M628.24,-77.47C643.86,-75.19 659.86,-72.85 675.44,-70.57"/>
<polygon fill="black" stroke="black" points="676.22,-73.99 685.61,-69.08 675.21,-67.07 676.22,-73.99"/>
</g>
<!-- hard -->
<g id="node8" class="node">
<title>hard</title>
<polygon fill="#e8f2ff" stroke="black" points="1785,-108.68 1489,-108.68 1489,-70.68 1785,-70.68 1785,-108.68"/>
<text text-anchor="middle" x="1637" y="-93.48" font-family="Times,serif" font-size="14.00">Hard IMLE (fallback if all masked)</text>
<text text-anchor="middle" x="1637" y="-78.48" font-family="Times,serif" font-size="14.00">L_hard = (1/B)∑_i min_{k∈K_i} D_{i,k}</text>
</g>
<!-- dist_item&#45;&gt;hard -->
<g id="edge8" class="edge">
<title>dist_item&#45;&gt;hard</title>
<path fill="none" stroke="black" d="M1152.25,-133.81C1241.28,-125.69 1374.63,-113.52 1478.8,-104.02"/>
<polygon fill="black" stroke="black" points="1479.14,-107.5 1488.78,-103.11 1478.51,-100.53 1479.14,-107.5"/>
</g>
<!-- eps -->
<g id="node6" class="node">
<title>eps</title>
<polygon fill="#d9edf7" stroke="black" points="1145,-80.18 963,-80.18 963,-27.18 1145,-27.18 1145,-80.18"/>
<text text-anchor="middle" x="1054" y="-64.98" font-family="Times,serif" font-size="14.00">ε update:</text>
<text text-anchor="middle" x="1054" y="-49.98" font-family="Times,serif" font-size="14.00">EMA toward q&#45;quantile</text>
<text text-anchor="middle" x="1054" y="-34.98" font-family="Times,serif" font-size="14.00">+ clamp [1e&#45;4, 0.2]</text>
</g>
<!-- dist_bg&#45;&gt;eps -->
<g id="edge5" class="edge">
<title>dist_bg&#45;&gt;eps</title>
<path fill="none" stroke="black" d="M898,-53.68C915.91,-53.68 934.48,-53.68 952.27,-53.68"/>
<polygon fill="black" stroke="black" points="952.65,-57.18 962.65,-53.68 952.65,-50.18 952.65,-57.18"/>
</g>
<!-- mask -->
<g id="node7" class="node">
<title>mask</title>
<polygon fill="#e8f2ff" stroke="black" points="1431,-71.68 1210,-71.68 1210,-35.68 1431,-35.68 1431,-71.68"/>
<text text-anchor="middle" x="1320.5" y="-49.98" font-family="Times,serif" font-size="14.00">Reject if min_j D_{i,k→j} &lt; ε</text>
</g>
<!-- dist_bg&#45;&gt;mask -->
<g id="edge6" class="edge">
<title>dist_bg&#45;&gt;mask</title>
<path fill="none" stroke="black" d="M872.53,-27.11C898.79,-19.59 928.36,-12.42 956,-8.68 1042.32,3.02 1065.64,2.72 1152,-8.68 1187.29,-13.34 1225.7,-23.29 1256.83,-32.65"/>
<polygon fill="black" stroke="black" points="1256.08,-36.08 1266.66,-35.66 1258.13,-29.39 1256.08,-36.08"/>
</g>
<!-- eps&#45;&gt;mask -->
<g id="edge7" class="edge">
<title>eps&#45;&gt;mask</title>
<path fill="none" stroke="black" d="M1145.29,-53.68C1162.84,-53.68 1181.49,-53.68 1199.82,-53.68"/>
<polygon fill="black" stroke="black" points="1199.96,-57.18 1209.96,-53.68 1199.96,-50.18 1199.96,-57.18"/>
</g>
<!-- mask&#45;&gt;hard -->
<g id="edge9" class="edge">
<title>mask&#45;&gt;hard</title>
<path fill="none" stroke="black" d="M1431.06,-66.22C1446.54,-67.99 1462.71,-69.84 1478.88,-71.69"/>
<polygon fill="black" stroke="black" points="1478.61,-75.19 1488.94,-72.85 1479.4,-68.23 1478.61,-75.19"/>
</g>
<!-- soft -->
<g id="node9" class="node">
<title>soft</title>
<polygon fill="#e8f2ff" stroke="black" points="2085,-108.68 1843,-108.68 1843,-70.68 2085,-70.68 2085,-108.68"/>
<text text-anchor="middle" x="1964" y="-93.48" font-family="Times,serif" font-size="14.00">Tiny soft coverage on distances</text>
<text text-anchor="middle" x="1964" y="-78.48" font-family="Times,serif" font-size="14.00">Top&#45;K&#39;, τ, λ≪1 (optional)</text>
</g>
<!-- hard&#45;&gt;soft -->
<g id="edge10" class="edge">
<title>hard&#45;&gt;soft</title>
<path fill="none" stroke="black" d="M1785.29,-89.68C1801.13,-89.68 1817.17,-89.68 1832.79,-89.68"/>
<polygon fill="black" stroke="black" points="1832.99,-93.18 1842.99,-89.68 1832.99,-86.18 1832.99,-93.18"/>
</g>
<!-- total -->
<g id="node10" class="node">
<title>total</title>
<polygon fill="#dff2bf" stroke="black" points="2392,-107.68 2143,-107.68 2143,-71.68 2392,-71.68 2392,-107.68"/>
<text text-anchor="middle" x="2267.5" y="-85.98" font-family="Times,serif" font-size="14.00">Total loss: L = L_hard + λ L_soft</text>
</g>
<!-- soft&#45;&gt;total -->
<g id="edge11" class="edge">
<title>soft&#45;&gt;total</title>
<path fill="none" stroke="black" d="M2085.03,-89.68C2100.65,-89.68 2116.74,-89.68 2132.57,-89.68"/>
<polygon fill="black" stroke="black" points="2132.94,-93.18 2142.94,-89.68 2132.94,-86.18 2132.94,-93.18"/>
</g>
</g>
</svg>
